"use strict";document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("introView"),e=(document.getElementById("solverView"),document.getElementById("gridView")),o=e.getContext("2d"),s=document.getElementById("startButton"),n=document.getElementById("width"),i=document.getElementById("height");let l=null;const r=o=>{t.hidden=!0,e.hidden=!1,l=o,a(),v(!0),window.game=l},c=t=>{localStorage.setItem("game",JSON.stringify(t))},f=()=>{let t=!0,e=!0;for(const o of l.status.cols){if(o<0){t=!1,e=!1;break}65535!==o&&(e=!1)}for(const o of l.status.rows){if(o<0){t=!1,e=!1;break}65535!==o&&(e=!1)}return l.status.global=t?e?65535:0:-65535,l.status.global},a=()=>{for(let t=0;t<l.config.width;t++)l.status.cols[t]=x(t);for(let t=0;t<l.config.height;t++)l.status.rows[t]=p(t);f()};window.nano=window.nano||{},window.nano.statusAll=a;const g=t=>{let e=t;for(;e.next;)m(e),e.next.start.min<=e.end.min&&(e.next.start.min=e.end.min+1),e.next.start.max>e.end.max+1&&(e.next.start.max=e.end.max+1),e=e.next;m(e)},d=t=>{let e=t;for(;e.prev;)m(e),e.prev.end.max>=e.start.max&&(e.prev.end.max=e.start.max-1),e.prev.end.min<e.start.min-1&&(e.prev.end.min=e.start.min-1),e=e.prev;m(e)},h=(t,e,o)=>{if(-1===e)return;if(o.type===e){const e=[];for(const s of o.possibilities)t!==s.start-1&&t!==s.end+1&&e.push(s);return void(e.length<o.possibilities.length&&(o.possibilities=e))}const s=[];for(const e of o.possibilities)e.start<=t&&t<=e.end||s.push(e);s.length<o.possibilities.length&&(o.possibilities=s)},m=t=>{const e={max:-1/0,min:1/0},o={end:{max:-1/0,min:1/0},start:{max:-1/0,min:1/0}},s=[];for(const n of t.possibilities){const i=n.end+1-n.start;n.start<t.start.min||(n.start>t.start.max||n.end<t.end.min||n.end>t.end.max||i<t.length.min||i>t.length.max||(s.push(n),n.start<o.start.min&&(o.start.min=n.start),n.start>o.start.max&&(o.start.max=n.start),n.end<o.end.min&&(o.end.min=n.end),n.end>o.end.max&&(o.end.max=n.end),i<e.min&&(e.min=i),i>e.max&&(e.max=i)))}s.length<t.possibilities.length&&(t.possibilities=s),t.possibilities.length>0&&(t.start=o.start,t.end=o.end,t.length=e)},u=(t,e)=>{const o=[];let s=0;for(const e of t)s+=e;let n=e.length-s-t.length+1;const i={end:{max:n-1,min:-1},length:{max:n,min:0},next:null,possibilities:[],prev:null,start:{max:0,min:0},type:0};o.push(i);let l=i,r=i;for(const e of t){const t=l.start.min+l.length.min;r={end:{max:t+e-1+n,min:t+e-1},length:{max:e,min:e},next:null,possibilities:[],prev:l,start:{max:t+n,min:t},type:1},l.next=r,o.push(r);const s=r.end.min+1;l={end:{max:s+n,min:s},length:{max:1+n,min:1},next:null,possibilities:[],prev:r,start:{max:s+n,min:s},type:0},r.next=l,o.push(l)}l.length.min--,l.length.max--,l.end.max--,l.end.min=l.end.max;for(const t of o)for(let e=t.start.min;e<=t.start.max;e++)for(let o=t.length.min;o<=t.length.max;o++){const s=e+o-1;t.end.min<=s&&s<=t.end.max&&t.possibilities.push({end:s,start:e})}g(i),d(l);for(const t of o)for(let o=0;o<e.length;o++)h(o,e[o],t);return g(i),d(l),o},w=(t,e)=>{const o=u(t,e);let s=1,n=0,i=!0;for(const t of o){const o=t.possibilities.length;if(o<1)return-65535;if(0===t.type)continue;let l=1===o;if(l){const o=t.possibilities[0];for(let s=o.start;s<=o.end;s++)if(e[s]!==t.type){l=!1;break}}l?n|=s:i=!1,s*=2}return i?65535:n},x=t=>{if(l.cols[t].length<1)return 0;const e=[];for(const o of l.grid)e.push(o[t]);return w(l.cols[t],e)},p=t=>l.rows[t].length<1?0:w(l.rows[t],l.grid[t]),y=()=>{const t=n.value;localStorage.setItem("width",t);const e=i.value;localStorage.setItem("height",e),((t,e)=>{const o={cols:[],config:{height:e,scale:10,width:t,xOffset:10,yOffset:10},grid:[],rows:[],status:{cols:[],rows:[],global:0}};for(let e=0;e<t;e++)o.cols[e]=[],o.status.cols[e]=0;for(let s=0;s<e;s++){o.rows[s]=[],o.status.rows[s]=0,o.grid[s]=[];for(let e=0;e<t;e++)o.grid[s][e]=-1}c(o),r(o)})(+t,+e)},v=t=>{(t=>{let e=1,o=1;for(const t of l.cols)t.length>e&&(e=t.length);for(const t of l.rows)t.length>o&&(o=t.length);if(t){const t=(window.innerWidth-10)/(o+l.config.width),s=(window.innerHeight-10)/(e+l.config.height);l.config.scale=Math.floor(t<s?t:s),l.config.scale<5&&(l.config.scale=5)}l.config.xOffset=l.config.scale*o,l.config.yOffset=l.config.scale*e})(t),e.width=l.config.xOffset+l.config.width*l.config.scale,e.height=l.config.yOffset+l.config.height*l.config.scale,o.clearRect(0,0,e.width,e.height),b();for(let t=0;t<l.config.width;t++)I(t);for(let t=0;t<l.config.height;t++)S(t);O()};window.nano=window.nano||{},window.nano.redraw=v;const b=()=>{l.status.global?o.fillStyle=l.status.global<0?"#FCC":"#CFC":o.fillStyle="white",o.fillRect(0,0,l.config.xOffset,l.config.yOffset)},O=()=>{for(let t=0;t<l.config.height;t++)for(let e=0;e<l.config.width;e++)C(e,t,l.grid[t][e])},I=t=>{const e=l.config.scale/2;let s=l.config.yOffset-l.cols[t].length*l.config.scale+e;const n=l.config.xOffset+t*l.config.scale+e;o.fillStyle=1&t?"#FFF":"#CCC",o.fillRect(n-e,0,l.config.scale,l.config.yOffset),o.font=.8*l.config.scale+"px Monospace",o.textAlign="center",o.textBaseline="middle";const i=l.status.cols[t]>0?"gray":"red",r=l.status.cols[t]>0?l.status.cols[t]:-l.status.cols[t];let c=1;for(let e of l.cols[t])o.fillStyle=r&c?i:"black",o.fillText(""+e,n,s),c*=2,s+=l.config.scale},S=t=>{const e=l.config.scale/2,s=l.config.yOffset+t*l.config.scale+e;let n=l.config.xOffset-l.rows[t].length*l.config.scale+e;o.fillStyle=1&t?"#FFF":"#CCC",o.fillRect(0,s-e,l.config.xOffset,l.config.scale),o.font=.8*l.config.scale+"px Monospace",o.textAlign="center",o.textBaseline="middle";const i=l.status.rows[t]>0?"gray":"red",r=l.status.rows[t]>0?l.status.rows[t]:-l.status.rows[t];let c=1;for(let e of l.rows[t])o.fillStyle=r&c?i:"black",o.fillText(""+e,n,s),c*=2,n+=l.config.scale},C=(t,e,s)=>{if(t<0||e<0||t>=l.config.width||e>=l.config.height)throw new Error("Outside game-grid: "+JSON.stringify({x:t,y:e,type:s}));const n=l.config.xOffset+t*l.config.scale,i=l.config.yOffset+e*l.config.scale;o.fillStyle="#808080",o.fillRect(n,i,l.config.scale,l.config.scale),o.fillStyle="#C0C0C0",o.fillRect(n,i,l.config.scale-1,l.config.scale-1),o.fillStyle="#404040",o.fillRect(n+1,i+1,l.config.scale-1,l.config.scale-1),o.fillStyle=s<0?"#808080":s?"black":"white",o.fillRect(n+1,i+1,l.config.scale-2,l.config.scale-2)},E=t=>{if(l.cols[t].length<1)return!1;const e=[];for(const o of l.grid)e.push(o[t]);let o=!1;const s=u(l.cols[t],e),n=l.status.global;for(const e of s)for(let s=e.start.max;s<=e.end.min;s++)if(l.grid[s][t]!==e.type){l.grid[s][t]=e.type,o=!0,C(t,s,e.type);const n=p(s);l.status.rows[s]!==n&&(l.status.rows[s]=n,S(s))}if(o){const e=x(t);l.status.cols[t]!==e&&(l.status.cols[t]=e,I(t)),n!==f()&&b(),c(l)}return o},K=(t,e)=>{if(e||l.cols[t].length<=0)return(t=>{const e=l.cols[t].join(" "),o=prompt("Config col "+(1+t),e);if(null===o||e===o)return;if(""===o)return l.cols[t].length=0,void c(l);const s=o.split(/[ ,]+/g),n=[];let i=0;for(const t of s){const e=Math.floor(+t);e>0&&n.push(e),i+=e}return n.length<1?(console.error("Invalid col: "+o),void alert("Invalid col: "+o)):i+n.length>l.config.height+1?(console.error("Invalid col-size: "+o),console.error(n),void alert("Invalid col-size: "+o)):(l.cols[t]=n,c(l),l.status.cols[t]=x(t),void I(t))})(t);E(t)},B=t=>{if(l.rows[t].length<1)return!1;let e=!1;const o=u(l.rows[t],l.grid[t]),s=l.status.global;for(const s of o)for(let o=s.start.max;o<=s.end.min;o++)if(l.grid[t][o]!==s.type){l.grid[t][o]=s.type,e=!0,C(o,t,s.type);const n=x(o);l.status.cols[o]!==n&&(l.status.cols[o]=n,I(o))}if(e){const e=p(t);l.status.rows[t]!==e&&(l.status.rows[t]=e,S(t)),s!==f()&&b(),c(l)}return e},R=(t,e)=>{if(e||l.rows[t].length<=0)return(t=>{const e=l.rows[t].join(" "),o=prompt("Config row "+(1+t),e);if(null===o||e===o)return;if(""===o)return l.rows[t].length=0,void c(l);const s=o.split(/[ ,]+/g),n=[];let i=0;for(const t of s){const e=Math.floor(+t);e>0&&n.push(e),i+=e}return n.length<1?(console.error("Invalid row: "+o),void alert("Invalid row: "+o)):i+n.length>l.config.width+1?(console.error("Invalid row-size: "+o),console.error({newList:n,width:l.config.width,sum:i,length:n.length,max:i+n.length-1}),void alert("Invalid row-size: "+o)):(l.rows[t]=n,c(l),l.status.rows[t]=p(t),void S(t))})(t);B(t)},k=t=>{const e=Math.floor((t.clientX-l.config.xOffset)/l.config.scale),o=Math.floor((t.clientY-l.config.yOffset)/l.config.scale);return e<0?o<0?(t=>{if(t.ctrlKey&&confirm("Delete game?"))localStorage.removeItem("game"),location.reload();else if(t.metaKey){for(let e=0;e<l.config.width;e++)if(E(e)&&!t.shiftKey)return;for(let e=0;e<l.config.height;e++)if(B(e)&&!t.shiftKey)return}else t.shiftKey&&confirm("Reset game?")?(c((t=>{t.grid=[],t.status={cols:[],rows:[],global:0};for(let e=0;e<t.config.width;e++)t.status.cols[e]=0;for(let e=0;e<t.config.height;e++){t.status.rows[e]=0,t.grid[e]=[];for(let o=0;o<t.config.width;o++)t.grid[e][o]=-1}return t})(l)),location.reload()):r(l)})(t):R(o,t.shiftKey||t.ctrlKey):o<0?K(e,t.shiftKey||t.ctrlKey):((t,e,o)=>{const s=(1+l.grid[e][t]+(o?1:2))%3-1;l.grid[e][t]=s,c(l),C(t,e,s);const n=l.status.global,i=x(t);l.status.cols[t]!==i&&(l.status.cols[t]=i,I(t));const r=p(e);l.status.rows[e]!==r&&(l.status.rows[e]=r,S(e)),n!==f()&&b()})(e,o,t.button>0||t.shiftKey)};(()=>{const t=localStorage.getItem("width"),e=localStorage.getItem("height"),o=localStorage.getItem("game");if(t&&(n.value=t),e&&(i.value=e),o){const t=JSON.parse(o);r(t)}})(),s.addEventListener("click",y,{once:!1,passive:!0}),e.addEventListener("click",k,{once:!1,passive:!0})},{once:!0,passive:!0});
//# sourceMappingURL=es6.js.map
