"use strict";var __awaiter=function(t,e,n,o){return new(n||(n=Promise))((function(i,s){function l(t){try{c(o.next(t))}catch(t){s(t)}}function r(t){try{c(o.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,r)}c((o=o.apply(t,e||[])).next())}))};document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("introView"),e=document.getElementById("importView"),n=document.getElementById("gridView"),o=n.getContext("2d"),i=t.querySelector('input[type="submit"]'),s=e.querySelector('input[type="file"]'),l=e.querySelector("textarea"),r=e.querySelector('input[type="submit"]'),c=document.getElementById("width"),f=document.getElementById("height"),a=()=>{let t=null;const e=new Promise(e=>t=e);return window.requestAnimationFrame(t),e};let g=null;const d=o=>{t.hidden=!0,e.hidden=!0,n.hidden=!1,g=o,m(),C(!0),window.game=g},u=t=>{localStorage.setItem("game",JSON.stringify(t))},h=()=>{let t=!0,e=!0;for(const n of g.status.cols){if(n<0){t=!1,e=!1;break}65535!==n&&(e=!1)}for(const n of g.status.rows){if(n<0){t=!1,e=!1;break}65535!==n&&(e=!1)}return g.status.global=t?e?65535:0:-65535,g.status.global},m=()=>{for(let t=0;t<g.config.width;t++)g.status.cols[t]=O(t);for(let t=0;t<g.config.height;t++)g.status.rows[t]=S(t);h()};window.nono=window.nono||{},window.nono.statusAll=m;const w=t=>{let e=t;for(;e.next;)v(e),e.next.start.min<=e.end.min&&(e.next.start.min=e.end.min+1),e.next.start.max>e.end.max+1&&(e.next.start.max=e.end.max+1),e=e.next;v(e)},p=t=>{let e=t;for(;e.prev;)v(e),e.prev.end.max>=e.start.max&&(e.prev.end.max=e.start.max-1),e.prev.end.min<e.start.min-1&&(e.prev.end.min=e.start.min-1),e=e.prev;v(e)},x=(t,e,n)=>{if(-1===e)return;if(n.type===e){const e=[];for(const o of n.possibilities)t!==o.start-1&&t!==o.end+1&&e.push(o);return void(e.length<n.possibilities.length&&(n.possibilities=e))}const o=[];for(const e of n.possibilities)e.start<=t&&t<=e.end||o.push(e);o.length<n.possibilities.length&&(n.possibilities=o)},v=t=>{const e={max:-1/0,min:1/0},n={end:{max:-1/0,min:1/0},start:{max:-1/0,min:1/0}},o=[];for(const i of t.possibilities){const s=i.end+1-i.start;i.start<t.start.min||(i.start>t.start.max||i.end<t.end.min||i.end>t.end.max||s<t.length.min||s>t.length.max||(o.push(i),i.start<n.start.min&&(n.start.min=i.start),i.start>n.start.max&&(n.start.max=i.start),i.end<n.end.min&&(n.end.min=i.end),i.end>n.end.max&&(n.end.max=i.end),s<e.min&&(e.min=s),s>e.max&&(e.max=s)))}o.length<t.possibilities.length&&(t.possibilities=o),t.possibilities.length>0&&(t.start=n.start,t.end=n.end,t.length=e)},y=(t,e)=>{const n=[];let o=0;for(const e of t)o+=e;let i=e.length-o-t.length+1;const s={end:{max:i-1,min:-1},length:{max:i,min:0},next:null,possibilities:[],prev:null,start:{max:0,min:0},type:0};n.push(s);let l=s,r=s;for(const e of t){const t=l.start.min+l.length.min;r={end:{max:t+e-1+i,min:t+e-1},length:{max:e,min:e},next:null,possibilities:[],prev:l,start:{max:t+i,min:t},type:1},l.next=r,n.push(r);const o=r.end.min+1;l={end:{max:o+i,min:o},length:{max:1+i,min:1},next:null,possibilities:[],prev:r,start:{max:o+i,min:o},type:0},r.next=l,n.push(l)}l.length.min--,l.length.max--,l.end.max--,l.end.min=l.end.max;for(const t of n)for(let e=t.start.min;e<=t.start.max;e++)for(let n=t.length.min;n<=t.length.max;n++){const o=e+n-1;t.end.min<=o&&o<=t.end.max&&t.possibilities.push({end:o,start:e})}w(s),p(l);for(const t of n)for(let n=0;n<e.length;n++)x(n,e[n],t);return w(s),p(l),n},b=(t,e)=>{const n=y(t,e);let o=1,i=0,s=!0;for(const t of n){const n=t.possibilities.length;if(n<1)return-65535;if(0===t.type)continue;let l=1===n;if(l){const n=t.possibilities[0];for(let o=n.start;o<=n.end;o++)if(e[o]!==t.type){l=!1;break}}l?i|=o:s=!1,o*=2}return s?65535:i},O=t=>{if(g.cols[t].length<1)return 0;const e=[];for(const n of g.grid)e.push(n[t]);return b(g.cols[t],e)},S=t=>g.rows[t].length<1?0:b(g.rows[t],g.grid[t]),E=(t,e)=>{const n={cols:[],config:{height:e,scale:10,width:t,xOffset:10,yOffset:10},grid:[],rows:[],status:{cols:[],rows:[],global:0}};for(let e=0;e<t;e++)n.cols[e]=[],n.status.cols[e]=0;for(let o=0;o<e;o++){n.rows[o]=[],n.status.rows[o]=0,n.grid[o]=[];for(let e=0;e<t;e++)n.grid[o][e]=-1}u(n),d(n)},M=()=>{const t=c.value;localStorage.setItem("width",t);const e=f.value;localStorage.setItem("height",e),E(+t,+e)},I=()=>__awaiter(void 0,void 0,void 0,(function*(){var t;s.value&&(l.value=yield(t=s,__awaiter(void 0,void 0,void 0,(function*(){const e=new Promise((e,n)=>{const o=new FileReader,i=()=>n(o.error);o.addEventListener("load",()=>e(o.result)),o.addEventListener("abort",i),o.addEventListener("error",i),o.readAsText(t.files[0])});return yield e,t.value=null,e}))))})),$=()=>{var t,e,n,o,i,s,r,c,f,a,h;const m=l.value.split("\n====\n");let w=[],p=[],x=0;const v=/^width (\d+)$/m,y=/^height (\d+)$/m,b=/^title "([^"]+)"/m,O=document.createElement("textarea");if(m.length>1){for(const o of m){const i=+(null===(t=v.exec(o))||void 0===t?void 0:t[1]),s=+(null===(e=y.exec(o))||void 0===e?void 0:e[1]),l=(null===(n=b.exec(o))||void 0===n?void 0:n[1])||"Nonogram";O.innerHTML=l;const r=O.value;i>0&&s>0&&(w.push(o),p.push(`${r} ${i}x${s}`))}w.length>1&&(x=+prompt("Select game, 0-"+(w.length-1)))}else{w.push(m[0]);const t=+(null===(o=v.exec(m[0]))||void 0===o?void 0:o[1]),e=+(null===(i=y.exec(m[0]))||void 0===i?void 0:i[1]),n=(null===(s=b.exec(m[0]))||void 0===s?void 0:s[1])||"Nonogram";O.innerHTML=n;const l=O.value;if(p.push(`${l} ${t}x${e}`),t<1||e<1)throw console.error("failed to read file: ",{width:t,height:e,title:l,content:m[0]}),alert("failed to read file: "+l),new Error("failed to read file: "+l)}const S=(null==w?void 0:w[x])||"",M=+(null===(r=v.exec(S))||void 0===r?void 0:r[1]),I=+(null===(c=y.exec(S))||void 0===c?void 0:c[1]),$=(null===(f=b.exec(S))||void 0===f?void 0:f[1])||"Nonogram";if(M<1||I<1)throw console.error("failed to read part: ",{selectedIndex:x,width:M,height:I,title:$,content:S}),alert("failed to read part: "+$),new Error("failed to read part: "+$);const C=null===(a=new RegExp("(^|\n)columns(\n[^\n]+){"+M+"}(\n|$)").exec(S))||void 0===a?void 0:a[0].trim().split("\n").slice(1),R=null===(h=new RegExp("(^|\n)rows(\n[^\n]+){"+I+"}(\n|$)").exec(S))||void 0===h?void 0:h[0].trim().split("\n").slice(1);localStorage.setItem("width",""+M),localStorage.setItem("height",""+I),E(M,I);const L=[];for(let t=0;t<M;t++)try{g.cols[t]=F(C[t],g.config.height,"col")}catch(t){L.push(t)}for(let t=0;t<I;t++)try{g.rows[t]=F(R[t],g.config.width,"row")}catch(t){L.push(t)}if(1===L.length)throw alert(L[0]),L[0];if(L.length>1){const t=[];for(const e of L)t.push(e.message);const e=t.join("\n");alert(e);const n=new Error(e);throw n.cause=L,n}u(g),d(g)},C=t=>{(t=>{let e=1,n=1;for(const t of g.cols)t.length>e&&(e=t.length);for(const t of g.rows)t.length>n&&(n=t.length);if(t){const t=(window.innerWidth-10)/(n+g.config.width),o=(window.innerHeight-10)/(e+g.config.height);g.config.scale=Math.floor(t<o?t:o),g.config.scale<5&&(g.config.scale=5)}g.config.xOffset=g.config.scale*n,g.config.yOffset=g.config.scale*e})(t),n.width=g.config.xOffset+g.config.width*g.config.scale,n.height=g.config.yOffset+g.config.height*g.config.scale,o.clearRect(0,0,n.width,n.height),R();for(let t=0;t<g.config.width;t++)K(t);for(let t=0;t<g.config.height;t++)k(t);L()};window.nono=window.nono||{},window.nono.redraw=C;const R=()=>{g.status.global?o.fillStyle=g.status.global<0?"#FCC":"#CFC":o.fillStyle="white",o.fillRect(0,0,g.config.xOffset,g.config.yOffset)},L=()=>{for(let t=0;t<g.config.height;t++)for(let e=0;e<g.config.width;e++)_(e,t,g.grid[t][e])},K=t=>{const e=g.config.scale/2;let n=g.config.yOffset-g.cols[t].length*g.config.scale+e;if(n<0)return!1;const i=g.config.xOffset+t*g.config.scale+e;o.fillStyle=1&t?"#FFF":"#CCC",o.fillRect(i-e,0,g.config.scale,g.config.yOffset),o.font=.8*g.config.scale+"px Monospace",o.textAlign="center",o.textBaseline="middle";const s=g.status.cols[t]>0?"gray":"red",l=g.status.cols[t]>0?g.status.cols[t]:-g.status.cols[t];let r=1;for(let e of g.cols[t])o.fillStyle=l&r?s:"black",o.fillText(""+e,i,n),r*=2,n+=g.config.scale;if(t>0&&t<g.config.width-1&&(t+1)%5<2&&g.status.global<1){const n=Math.max(1,Math.floor(g.config.scale/30));o.fillStyle="black",t%5==4?o.fillRect(i+e-n,0,n,g.config.yOffset):(o.fillStyle="black",o.fillRect(i-e,0,n,g.config.yOffset))}return!0},k=t=>{const e=g.config.scale/2,n=g.config.yOffset+t*g.config.scale+e;let i=g.config.xOffset-g.rows[t].length*g.config.scale+e;if(i<0)return!1;o.fillStyle=1&t?"#FFF":"#CCC",o.fillRect(0,n-e,g.config.xOffset,g.config.scale),o.font=.8*g.config.scale+"px Monospace",o.textAlign="center",o.textBaseline="middle";const s=g.status.rows[t]>0?"gray":"red",l=g.status.rows[t]>0?g.status.rows[t]:-g.status.rows[t];let r=1;for(let e of g.rows[t])o.fillStyle=l&r?s:"black",o.fillText(""+e,i,n),r*=2,i+=g.config.scale;if(t>0&&t<g.config.height-1&&(t+1)%5<2&&g.status.global<1){const i=Math.max(1,Math.floor(g.config.scale/30));o.fillStyle="black",t%5==4?o.fillRect(0,n+e-i,g.config.xOffset,i):(o.fillStyle="black",o.fillRect(0,n-e,g.config.xOffset,i))}return!0},_=(t,e,n)=>{if(t<0||e<0||t>=g.config.width||e>=g.config.height)throw new Error("Outside game-grid: "+JSON.stringify({x:t,y:e,type:n}));const i=g.config.xOffset+t*g.config.scale,s=g.config.yOffset+e*g.config.scale;o.fillStyle="#808080",o.fillRect(i,s,g.config.scale,g.config.scale),o.fillStyle="#C0C0C0",o.fillRect(i,s,g.config.scale-1,g.config.scale-1),o.fillStyle="#404040",o.fillRect(i+1,s+1,g.config.scale-1,g.config.scale-1),o.fillStyle=n<0?"#808080":n?"black":"white",g.status.global>0?o.fillRect(i,s,g.config.scale,g.config.scale):o.fillRect(i+1,s+1,g.config.scale-2,g.config.scale-2)},F=(t,e,n)=>{const o=t.split(/[ ,]+/g),i=[];let s=0;for(const t of o){const e=Math.floor(+t);e>0&&i.push(e),s+=e}if(i.length<1)throw console.error(`Invalid ${n}: ${t}`),new Error(`Invalid ${n}: ${t}`);if(s+i.length>e+1)throw console.error(`Invalid ${n}-size: ${t}`),console.error(i),new Error(`Invalid ${n}-size: ${t}`);return i},B=t=>{const e=g.cols[t].join(" "),n=prompt("Config col "+(1+t),e);if(null===n)return!1;if(e===n)return!0;if(""===n)return g.cols[t].length=0,u(g),!0;try{g.cols[t]=F(n,g.config.height,"col")}catch(t){throw alert(t.message),t}return u(g),g.status.cols[t]=O(t),K(t)||C(!0),!0},N=t=>{if(g.cols[t].length<1)return!1;const e=[],n=[];for(const o of g.grid)o[t]<0?e.push([]):e.push([o[t]]),n.push(o[t]);let o=!1;const i=y(g.cols[t],n),s=g.status.global;for(const n of i){for(const t of n.possibilities)for(let o=t.start;o<=t.end;o++)(0===e[o].length||1===e[o].length&&e[o][0]!==n.type)&&e[o].push(n.type);for(let e=n.start.max;e<=n.end.min;e++)if(g.grid[e][t]!==n.type){g.grid[e][t]=n.type,o=!0,_(t,e,g.grid[e][t]);const i=S(e);g.status.rows[e]!==i&&(g.status.rows[e]=i,k(e))}}for(let n=0;n<g.config.height;n++)if(-1===g.grid[n][t]&&1===e[n].length){g.grid[n][t]=e[n][0],o=!0,_(t,n,g.grid[n][t]);const i=S(n);g.status.rows[n]!==i&&(g.status.rows[n]=i,k(n))}if(o){const e=O(t);g.status.cols[t]!==e&&(g.status.cols[t]=e,K(t)),s!==h()&&(g.status.global>0?C(!1):R()),u(g)}return o},q=t=>{const e=g.rows[t].join(" "),n=prompt("Config row "+(1+t),e);if(null===n)return!1;if(e===n)return!0;if(""===n)return g.rows[t].length=0,u(g),!0;try{g.rows[t]=F(n,g.config.width,"row")}catch(t){throw alert(t.message),t}return u(g),g.status.rows[t]=S(t),k(t)||C(!0),!0},A=t=>{if(g.rows[t].length<1)return!1;let e=!1;const n=y(g.rows[t],g.grid[t]),o=g.status.global;for(const o of n)for(let n=o.start.max;n<=o.end.min;n++)if(g.grid[t][n]!==o.type){g.grid[t][n]=o.type,e=!0,_(n,t,o.type);const i=O(n);g.status.cols[n]!==i&&(g.status.cols[n]=i,K(n))}if(e){const e=S(t);g.status.rows[t]!==e&&(g.status.rows[t]=e,k(t)),o!==h()&&(g.status.global>0?C(!1):R()),u(g)}return e},T=t=>{const e=Math.floor((t.clientX-g.config.xOffset)/g.config.scale),n=Math.floor((t.clientY-g.config.yOffset)/g.config.scale);return e<0?n<0?(t=>{__awaiter(void 0,void 0,void 0,(function*(){if(t.metaKey||t.altKey){let e=!1;do{e=!1;for(let n=0;n<g.config.width;n++)if(N(n)){if(!t.shiftKey)return;e=!0,yield a()}for(let n=0;n<g.config.height;n++)if(A(n)){if(!t.shiftKey)return;e=!0,yield a()}}while(e&&t.ctrlKey&&t.shiftKey)}else if(t.ctrlKey&&confirm("Delete game?"))localStorage.removeItem("game"),location.reload();else if(t.shiftKey&&confirm("Reset game?"))u((t=>{t.grid=[],t.status={cols:[],rows:[],global:0};for(let e=0;e<t.config.width;e++)t.status.cols[e]=0;for(let e=0;e<t.config.height;e++){t.status.rows[e]=0,t.grid[e]=[];for(let n=0;n<t.config.width;n++)t.grid[e][n]=-1}return t})(g)),location.reload();else{d(g);for(let t=0;t<g.config.width;t++){if(!B(t))return;yield a()}for(let t=0;t<g.config.height;t++){if(!q(t))return;yield a()}}}))})(t):((t,e)=>{e||g.rows[t].length<=0?q(t)&&__awaiter(void 0,void 0,void 0,(function*(){for(yield a();++t<g.config.height&&g.rows[t].length<=0&&q(t);)yield a()})):A(t)})(n,t.shiftKey||t.ctrlKey):n<0?((t,e)=>{e||g.cols[t].length<=0?B(t)&&__awaiter(void 0,void 0,void 0,(function*(){for(yield a();++t<g.config.width&&g.cols[t].length<=0&&B(t);)yield a()})):N(t)})(e,t.shiftKey||t.ctrlKey):null!==H&&H===e&&null!==J&&J===n?(H=null,void(J=null)):((t,e,n)=>{const o=(1+g.grid[e][t]+(n?1:2))%3-1;g.grid[e][t]=o,u(g),_(t,e,o);const i=g.status.global,s=O(t);g.status.cols[t]!==s&&(g.status.cols[t]=s,K(t));const l=S(e);g.status.rows[e]!==l&&(g.status.rows[e]=l,k(e)),i!==h()&&(g.status.global>0?C(!1):R())})(e,n,t.button>0||t.shiftKey)};let X=null,Y=null,j=null,H=null,J=null;const P=t=>{const e=Math.floor((t.clientX-g.config.xOffset)/g.config.scale),o=Math.floor((t.clientY-g.config.yOffset)/g.config.scale);if(e<0||o<0||e>=g.config.width||o>=g.config.height)return;const i=t.button>0||t.shiftKey?1:2;X=(1+g.grid[o][e]+i)%3-1,Y=e,j=o,H=e,J=o,n.addEventListener("mousemove",D,{once:!1,passive:!0}),n.addEventListener("mouseup",z,{once:!0,passive:!0})},V=t=>{X=null,Y=null,j=null,t?(m(),C(!1)):L(),n.removeEventListener("mousemove",D),n.removeEventListener("mouseup",z)},z=t=>{if(null==Y||null==j||null===X)return V(!1);const e=Math.floor((t.clientX-g.config.xOffset)/g.config.scale),n=Math.floor((t.clientY-g.config.yOffset)/g.config.scale),o=Math.max(0,Math.min(g.config.width-1,e)),i=Math.max(0,Math.min(g.config.height-1,n));if(e!==o||n!==i)return V(!1);const s=o<Y?o:Y,l=o>Y?o:Y,r=i<j?i:j,c=i>j?i:j;if(s===l&&r===c)return H=null,J=null,V(!1);D(t);for(let t=s;t<=l;t++)for(let e=r;e<=c;e++)g.grid[e][t]=X;return V(!0)},D=t=>{if(null==Y||null==j||null===X)return V(!1);const e=Math.floor((t.clientX-g.config.xOffset)/g.config.scale),n=Math.floor((t.clientY-g.config.yOffset)/g.config.scale),o=e<0||e>=g.config.width-1?Y:e,i=n<0||n>=g.config.height-1?j:n;if(o===H&&i===J)return;const s=o<Y?o:Y,l=o<H?o:H,r=o>Y?o:Y,c=o>H?o:H,f=r>c?r:c,a=i<j?i:j,d=i<J?i:J,u=a<d?a:d,h=i>j?i:j,m=i>J?i:J,w=h>m?h:m;for(let t=s<l?s:l;t<=f;t++)for(let e=u;e<=w;e++)_(t,e,s<=t&&t<=r&&a<=e&&e<=h?X:g.grid[e][t]);H=o,J=i};(()=>{const t=localStorage.getItem("width"),e=localStorage.getItem("height"),n=localStorage.getItem("game");if(t&&(c.value=t),e&&(f.value=e),n){const t=JSON.parse(n);d(t)}})(),i.addEventListener("click",M,{once:!1,passive:!0}),r.addEventListener("click",$,{once:!1,passive:!0}),s.addEventListener("change",I,{once:!1,passive:!0}),n.addEventListener("click",T,{once:!1,passive:!0}),n.addEventListener("mousedown",P,{once:!1,passive:!0})},{once:!0,passive:!0});
//# sourceMappingURL=es6.js.map
