"use strict";var __awaiter=function(e,l,a,s){return new(a=a||Promise)(function(n,t){function i(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,r)}o((s=s.apply(e,l||[])).next())})},__generator=function(n,i){var r,o,l,a={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(l=2&t[0]?o.return:t[0]?o.throw||((l=o.return)&&l.call(o),0):o.next)&&!(l=l.call(o,t[1])).done)return l;switch(o=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(l=0<(l=a.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3])){a.label=t[1];break}if(6===t[0]&&a.label<l[1]){a.label=l[1],l=t;break}if(l&&a.label<l[2]){a.label=l[2],a.ops.push(t);break}l[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(n,a)}catch(e){t=[6,e],o=0}finally{r=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=void 0;document.addEventListener("DOMContentLoaded",function(){function l(){var t=null,e=new Promise(function(e){return t=e});return window.requestAnimationFrame(t),e}function C(e){localStorage.setItem("game",JSON.stringify(e))}function w(){for(var e=!0,t=!0,n=0,i=L.status.cols;n<i.length;n++){var r=i[n];if(r<0){t=e=!1;break}65535!==r&&(t=!1)}for(var o=0,l=L.status.rows;o<l.length;o++){var a=l[o];if(a<0){t=e=!1;break}65535!==a&&(t=!1)}return L.status.global=e?t?65535:0:-65535,L.status.global}var t=document.getElementById("introView"),n=document.getElementById("importView"),i=document.getElementById("gridView"),u=i.getContext("2d"),e=t.querySelector('input[type="submit"]'),o=n.querySelector('input[type="file"]'),R=n.querySelector("textarea"),r=n.querySelector('input[type="submit"]'),a=document.getElementById("width"),s=document.getElementById("height"),L=null,K=function(e){t.hidden=!0,n.hidden=!0,i.hidden=!1,L=e,c(),b(!0),window.game=L},c=function(){for(var e=0;e<L.config.width;e++)L.status.cols[e]=x(e);for(var t=0;t<L.config.height;t++)L.status.rows[t]=y(t);w()};window.nono=window.nono||{},window.nono.statusAll=c;function S(e){for(var t=e;t.next;)v(t),t.next.start.min<=t.end.min&&(t.next.start.min=t.end.min+1),t.next.start.max>t.end.max+1&&(t.next.start.max=t.end.max+1),t=t.next;v(t)}function _(e){for(var t=e;t.prev;)v(t),t.prev.end.max>=t.start.max&&(t.prev.end.max=t.start.max-1),t.prev.end.min<t.start.min-1&&(t.prev.end.min=t.start.min-1),t=t.prev;v(t)}function p(e,t){for(var n=[],i=0,r=0,o=e;r<o.length;r++)i+=o[r];var l=t.length-i-e.length+1,a={end:{max:l-1,min:-1},length:{max:l,min:0},next:null,possibilities:[],prev:null,start:{max:0,min:0},type:0};n.push(a);for(var s=a,c=a,f=0,u=e;f<u.length;f++){var g=u[f],h=s.start.min+s.length.min,c={end:{max:h+g-1+l,min:h+g-1},length:{max:g,min:g},next:null,possibilities:[],prev:s,start:{max:h+l,min:h},type:1};s.next=c,n.push(c);h=c.end.min+1,s={end:{max:h+l,min:h},length:{max:1+l,min:1},next:null,possibilities:[],prev:c,start:{max:h+l,min:h},type:0};c.next=s,n.push(s)}s.length.min--,s.length.max--,s.end.max--,s.end.min=s.end.max;for(var d=0,v=n;d<v.length;d++)for(var m=(b=v[d]).start.min;m<=b.start.max;m++)for(var w=b.length.min;w<=b.length.max;w++){var p=m+w-1;b.end.min<=p&&p<=b.end.max&&b.possibilities.push({end:p,start:m})}S(a),_(s);for(var x=0,y=n;x<y.length;x++)for(var b=y[x],O=0;O<t.length;O++)!function(e,t,n){if(-1!==t)if(n.type!==t){for(var i=[],r=0,o=n.possibilities;r<o.length;r++)(l=o[r]).start<=e&&e<=l.end||i.push(l);i.length<n.possibilities.length&&(n.possibilities=i)}else{for(var l,a=[],s=0,c=n.possibilities;s<c.length;s++)e!==(l=c[s]).start-1&&e!==l.end+1&&a.push(l);a.length<n.possibilities.length&&(n.possibilities=a)}}(O,t[O],b);return S(a),_(s),n}function f(e,t){for(var n=1,i=0,r=!0,o=0,l=p(e,t);o<l.length;o++){var a=l[o],s=a.possibilities.length;if(s<1)return-65535;if(0!==a.type){var c=1===s;if(c)for(var f=a.possibilities[0],u=f.start;u<=f.end;u++)if(t[u]!==a.type){c=!1;break}c?i|=n:r=!1,n*=2}}return r?65535:i}function F(e,t){for(var n={cols:[],config:{height:t,scale:10,width:e,xOffset:10,yOffset:10},grid:[],rows:[],status:{cols:[],rows:[],global:0}},i=0;i<e;i++)n.cols[i]=[],n.status.cols[i]=0;for(var r=0;r<t;r++){n.rows[r]=[],n.status.rows[r]=0,n.grid[r]=[];for(i=0;i<e;i++)n.grid[r][i]=-1}C(n),K(n)}function g(){var e=a.value;localStorage.setItem("width",e);var t=s.value;localStorage.setItem("height",t),F(+e,+t)}function h(){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return o.value?(t=R,[4,(r=o,__awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,t=new Promise(function(e,t){function n(){return t(i.error)}var i=new FileReader;i.addEventListener("load",function(){return e(i.result)}),i.addEventListener("abort",n),i.addEventListener("error",n),i.readAsText(r.files[0])})];case 1:return e.sent(),r.value=null,[2,t]}})}))]):[2];case 1:return t.value=e.sent(),[2]}var r})})}function d(){var e=R.value.split("\n====\n"),t=[],n=[],i=0,r=/^width (\d+)$/m,o=/^height (\d+)$/m,l=/^title "([^"]+)"/m,a=document.createElement("textarea");if(1<e.length){for(var s=0,c=e;s<c.length;s++){var f=c[s],u=+(null===(g=r.exec(f))||void 0===g?void 0:g[1]),g=+(null===(d=o.exec(f))||void 0===d?void 0:d[1]),h=(null===(d=l.exec(f))||void 0===d?void 0:d[1])||"Nonogram";a.innerHTML=h;var d=a.value;0<u&&0<g&&(t.push(f),n.push(d+" "+u+"x"+g))}1<t.length&&(i=+prompt("Select game, 0-"+(t.length-1)))}else{t.push(e[0]);var v=+(null===(m=r.exec(e[0]))||void 0===m?void 0:m[1]),m=+(null===(w=o.exec(e[0]))||void 0===w?void 0:w[1]),h=(null===(w=l.exec(e[0]))||void 0===w?void 0:w[1])||"Nonogram";a.innerHTML=h;var w=a.value;if(n.push(w+" "+v+"x"+m),v<1||m<1)throw console.error("failed to read file: ",{width:v,height:m,title:w,content:e[0]}),alert("failed to read file: "+w),new Error("failed to read file: "+w)}var e=(null==t?void 0:t[i])||"",p=+(null===(w=r.exec(e))||void 0===w?void 0:w[1]),x=+(null===(w=o.exec(e))||void 0===w?void 0:w[1]),w=(null===(w=l.exec(e))||void 0===w?void 0:w[1])||"Nonogram";if(p<1||x<1)throw console.error("failed to read part: ",{selectedIndex:i,width:p,height:x,title:w,content:e}),alert("failed to read part: "+w),new Error("failed to read part: "+w);var y=null===(w=new RegExp("(^|\n)columns(\n[^\n]+){"+p+"}(\n|$)").exec(e))||void 0===w?void 0:w[0].trim().split("\n").slice(1),b=null===(e=new RegExp("(^|\n)rows(\n[^\n]+){"+x+"}(\n|$)").exec(e))||void 0===e?void 0:e[0].trim().split("\n").slice(1);localStorage.setItem("width",""+p),localStorage.setItem("height",""+x),F(p,x);for(var O=[],S=0;S<p;S++)try{L.cols[S]=$(y[S],L.config.height,"col")}catch(e){O.push(e)}for(var _=0;_<x;_++)try{L.rows[_]=$(b[_],L.config.width,"row")}catch(e){O.push(e)}if(1===O.length)throw alert(O[0]),O[0];if(1<O.length){for(var E=[],M=0,I=O;M<I.length;M++){var k=I[M];E.push(k.message)}e=E.join("\n");alert(e);e=new Error(e);throw e.cause=O,e}C(L),K(L)}var v=function(e){for(var t={max:-1/0,min:1/0},n={end:{max:-1/0,min:1/0},start:{max:-1/0,min:1/0}},i=[],r=0,o=e.possibilities;r<o.length;r++){var l=o[r],a=l.end+1-l.start;l.start<e.start.min||l.start>e.start.max||l.end<e.end.min||l.end>e.end.max||a<e.length.min||a>e.length.max||(i.push(l),l.start<n.start.min&&(n.start.min=l.start),l.start>n.start.max&&(n.start.max=l.start),l.end<n.end.min&&(n.end.min=l.end),l.end>n.end.max&&(n.end.max=l.end),a<t.min&&(t.min=a),a>t.max&&(t.max=a))}i.length<e.possibilities.length&&(e.possibilities=i),0<e.possibilities.length&&(e.start=n.start,e.end=n.end,e.length=t)},x=function(e){if(L.cols[e].length<1)return 0;for(var t=[],n=0,i=L.grid;n<i.length;n++){var r=i[n];t.push(r[e])}return f(L.cols[e],t)},y=function(e){return L.rows[e].length<1?0:f(L.rows[e],L.grid[e])},b=function(e){!function(e){for(var t=1,n=1,i=0,r=L.cols;i<r.length;i++){var o=r[i];o.length>t&&(t=o.length)}for(var l,a=0,s=L.rows;a<s.length;a++){var c=s[a];c.length>n&&(n=c.length)}e&&(l=(window.innerWidth-10)/(n+L.config.width),e=(window.innerHeight-10)/(t+L.config.height),L.config.scale=Math.floor(l<e?l:e),L.config.scale<5&&(L.config.scale=5)),L.config.xOffset=L.config.scale*n,L.config.yOffset=L.config.scale*t}(e),i.width=L.config.xOffset+L.config.width*L.config.scale,i.height=L.config.yOffset+L.config.height*L.config.scale,u.clearRect(0,0,i.width,i.height),T();for(var t=0;t<L.config.width;t++)A(t);for(var n=0;n<L.config.height;n++)X(n);q()};window.nono=window.nono||{},window.nono.redraw=b;function m(e){var t=L.cols[e].join(" "),n=prompt("Config col "+(1+e),t);if(null!==n){if(t===n)return 1;if(""===n)return L.cols[e].length=0,C(L),1;try{L.cols[e]=$(n,L.config.height,"col")}catch(e){throw alert(e.message),e}return C(L),L.status.cols[e]=x(e),A(e)||b(!0),1}}function O(e){if(!(L.cols[e].length<1)){for(var t=[],n=[],i=0,r=L.grid;i<r.length;i++){var o=r[i];o[e]<0?t.push([]):t.push([o[e]]),n.push(o[e])}for(var l=!1,a=p(L.cols[e],n),s=L.status.global,c=0,f=a;c<f.length;c++){for(var u=f[c],g=0,h=u.possibilities;g<h.length;g++)for(var d=h[g],v=d.start;v<=d.end;v++)(0===t[v].length||1===t[v].length&&t[v][0]!==u.type)&&t[v].push(u.type);for(v=u.start.max;v<=u.end.min;v++)L.grid[v][e]!==u.type&&(L.grid[v][e]=u.type,l=!0,Y(e,v,L.grid[v][e]),m=y(v),L.status.rows[v]!==m&&(L.status.rows[v]=m,X(v)))}for(var m,v=0;v<L.config.height;v++)-1===L.grid[v][e]&&1===t[v].length&&(L.grid[v][e]=t[v][0],l=!0,Y(e,v,L.grid[v][e]),m=y(v),L.status.rows[v]!==m&&(L.status.rows[v]=m,X(v)));return l&&(a=x(e),L.status.cols[e]!==a&&(L.status.cols[e]=a,A(e)),s!==w()&&(0<L.status.global?b(!1):T()),C(L)),l}}function E(e){var t=L.rows[e].join(" "),n=prompt("Config row "+(1+e),t);if(null!==n){if(t===n)return 1;if(""===n)return L.rows[e].length=0,C(L),1;try{L.rows[e]=$(n,L.config.width,"row")}catch(e){throw alert(e.message),e}return C(L),L.status.rows[e]=y(e),X(e)||b(!0),1}}function M(e){if(!(L.rows[e].length<1)){for(var t=!1,n=p(L.rows[e],L.grid[e]),i=L.status.global,r=0,o=n;r<o.length;r++)for(var l,a=o[r],s=a.start.max;s<=a.end.min;s++)L.grid[e][s]!==a.type&&(L.grid[e][s]=a.type,t=!0,Y(s,e,a.type),l=x(s),L.status.cols[s]!==l&&(L.status.cols[s]=l,A(s)));return t&&(n=y(e),L.status.rows[e]!==n&&(L.status.rows[e]=n,X(e)),i!==w()&&(0<L.status.global?b(!1):T()),C(L)),t}}function I(e){P=J=H=null,e?(c(),b(!1)):q(),i.removeEventListener("mousemove",W),i.removeEventListener("mouseup",G)}var k,B,N,T=function(){L.status.global?u.fillStyle=L.status.global<0?"#FCC":"#CFC":u.fillStyle="white",u.fillRect(0,0,L.config.xOffset,L.config.yOffset)},q=function(){for(var e=0;e<L.config.height;e++)for(var t=0;t<L.config.width;t++)Y(t,e,L.grid[e][t])},A=function(e){var t=L.config.scale/2,n=L.config.yOffset-L.cols[e].length*L.config.scale+t;if(n<0)return!1;var i=L.config.xOffset+e*L.config.scale+t;u.fillStyle=1&e?"#FFF":"#CCC",u.fillRect(i-t,0,L.config.scale,L.config.yOffset),u.font=.8*L.config.scale+"px Monospace",u.textAlign="center",u.textBaseline="middle";for(var r,o=0<L.status.cols[e]?"gray":"red",l=0<L.status.cols[e]?L.status.cols[e]:-L.status.cols[e],a=1,s=0,c=L.cols[e];s<c.length;s++){var f=c[s];u.fillStyle=l&a?o:"black",u.fillText(""+f,i,n),a*=2,n+=L.config.scale}return 0<e&&e<L.config.width-1&&(e+1)%5<2&&L.status.global<1&&(r=Math.max(1,Math.floor(L.config.scale/30)),u.fillStyle="black",e%5==4?u.fillRect(i+t-r,0,r,L.config.yOffset):(u.fillStyle="black",u.fillRect(i-t,0,r,L.config.yOffset))),!0},X=function(e){var t=L.config.scale/2,n=L.config.yOffset+e*L.config.scale+t,i=L.config.xOffset-L.rows[e].length*L.config.scale+t;if(i<0)return!1;u.fillStyle=1&e?"#FFF":"#CCC",u.fillRect(0,n-t,L.config.xOffset,L.config.scale),u.font=.8*L.config.scale+"px Monospace",u.textAlign="center",u.textBaseline="middle";for(var r,o=0<L.status.rows[e]?"gray":"red",l=0<L.status.rows[e]?L.status.rows[e]:-L.status.rows[e],a=1,s=0,c=L.rows[e];s<c.length;s++){var f=c[s];u.fillStyle=l&a?o:"black",u.fillText(""+f,i,n),a*=2,i+=L.config.scale}return 0<e&&e<L.config.height-1&&(e+1)%5<2&&L.status.global<1&&(r=Math.max(1,Math.floor(L.config.scale/30)),u.fillStyle="black",e%5==4?u.fillRect(0,n+t-r,L.config.xOffset,r):(u.fillStyle="black",u.fillRect(0,n-t,L.config.xOffset,r))),!0},Y=function(e,t,n){if(e<0||t<0||e>=L.config.width||t>=L.config.height)throw new Error("Outside game-grid: "+JSON.stringify({x:e,y:t,type:n}));e=L.config.xOffset+e*L.config.scale,t=L.config.yOffset+t*L.config.scale;u.fillStyle="#808080",u.fillRect(e,t,L.config.scale,L.config.scale),u.fillStyle="#C0C0C0",u.fillRect(e,t,L.config.scale-1,L.config.scale-1),u.fillStyle="#404040",u.fillRect(e+1,t+1,L.config.scale-1,L.config.scale-1),u.fillStyle=n<0?"#808080":n?"black":"white",0<L.status.global?u.fillRect(e,t,L.config.scale,L.config.scale):u.fillRect(e+1,t+1,L.config.scale-2,L.config.scale-2)},$=function(e,t,n){for(var i=[],r=0,o=0,l=e.split(/[ ,]+/g);o<l.length;o++){var a=l[o],a=Math.floor(+a);0<a&&i.push(a),r+=a}if(i.length<1)throw console.error("Invalid "+n+": "+e),new Error("Invalid "+n+": "+e);if(r+i.length>t+1)throw console.error("Invalid "+n+"-size: "+e),console.error(i),new Error("Invalid "+n+"-size: "+e);return i},j=function(e){var t,r,n,i=Math.floor((e.clientX-L.config.xOffset)/L.config.scale),o=Math.floor((e.clientY-L.config.yOffset)/L.config.scale);return i<0?o<0?(r=e,void __awaiter(_this,void 0,void 0,function(){var t,n,i;return __generator(this,function(e){switch(e.label){case 0:if(!r.metaKey&&!r.altKey)return[3,11];t=!1,e.label=1;case 1:t=!1,n=0,e.label=2;case 2:return n<L.config.width?O(n)?r.shiftKey?(t=!0,[4,l()]):[2]:[3,4]:[3,5];case 3:e.sent(),e.label=4;case 4:return n++,[3,2];case 5:i=0,e.label=6;case 6:return i<L.config.height?M(i)?r.shiftKey?(t=!0,[4,l()]):[2]:[3,8]:[3,9];case 7:e.sent(),e.label=8;case 8:return i++,[3,6];case 9:if(t&&r.ctrlKey&&r.shiftKey)return[3,1];e.label=10;case 10:return[3,21];case 11:return r.ctrlKey&&confirm("Delete game?")?(localStorage.removeItem("game"),location.reload(),[3,21]):[3,12];case 12:return r.shiftKey&&confirm("Reset game?")?(C(function(e){e.grid=[],e.status={cols:[],rows:[],global:0};for(var t=0;t<e.config.width;t++)e.status.cols[t]=0;for(var n=0;n<e.config.height;n++){e.status.rows[n]=0,e.grid[n]=[];for(t=0;t<e.config.width;t++)e.grid[n][t]=-1}return e}(L)),location.reload(),[3,21]):[3,13];case 13:K(L),n=0,e.label=14;case 14:return n<L.config.width?m(n)?[4,l()]:[2]:[3,17];case 15:e.sent(),e.label=16;case 16:return n++,[3,14];case 17:i=0,e.label=18;case 18:return i<L.config.height?E(i)?[4,l()]:[2]:[3,21];case 19:e.sent(),e.label=20;case 20:return i++,[3,18];case 21:return[2]}})})):(t=o,void(e.shiftKey||e.ctrlKey||L.rows[t].length<=0?E(t)&&__awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,l()];case 1:e.sent(),e.label=2;case 2:return++t<L.config.height&&L.rows[t].length<=0&&E(t)?[4,l()]:[3,4];case 3:return e.sent(),[3,2];case 4:return[2]}})}):M(t))):o<0?(n=i,void(e.shiftKey||e.ctrlKey||L.cols[n].length<=0?m(n)&&__awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,l()];case 1:e.sent(),e.label=2;case 2:return++n<L.config.width&&L.cols[n].length<=0&&m(n)?[4,l()]:[3,4];case 3:return e.sent(),[3,2];case 4:return[2]}})}):O(n))):null===V||V!==i||null===z||z!==o?function(e,t,n){var i=(1+L.grid[t][e]+(n?1:2))%3-1;L.grid[t][e]=i,C(L),Y(e,t,i);n=L.status.global,i=x(e);L.status.cols[e]!==i&&(L.status.cols[e]=i,A(e));e=y(t);L.status.rows[t]!==e&&(L.status.rows[t]=e,X(t)),n!==w()&&(0<L.status.global?b(!1):T())}(i,o,0<e.button||e.shiftKey):void(z=V=null)},H=null,J=null,P=null,V=null,z=null,D=function(e){var t=Math.floor((e.clientX-L.config.xOffset)/L.config.scale),n=Math.floor((e.clientY-L.config.yOffset)/L.config.scale);t<0||n<0||t>=L.config.width||n>=L.config.height||(e=0<e.button||e.shiftKey?1:2,H=(1+L.grid[n][t]+e)%3-1,V=J=t,z=P=n,i.addEventListener("mousemove",W,{once:!1,passive:!0}),i.addEventListener("mouseup",G,{once:!0,passive:!0}))},G=function(e){if(null==J||null==P||null===H)return I(!1);var t=Math.floor((e.clientX-L.config.xOffset)/L.config.scale),n=Math.floor((e.clientY-L.config.yOffset)/L.config.scale),i=Math.max(0,Math.min(L.config.width-1,t)),r=Math.max(0,Math.min(L.config.height-1,n));if(t!==i||n!==r)return I(!1);var n=i<J?i:J,o=J<i?i:J,l=r<P?r:P,a=P<r?r:P;if(n===o&&l===a)return z=V=null,I(!1);W(e);for(var s=n;s<=o;s++)for(var c=l;c<=a;c++)L.grid[c][s]=H;return I(!0)},W=function(e){if(null==J||null==P||null===H)return I(!1);var t=Math.floor((e.clientX-L.config.xOffset)/L.config.scale),n=Math.floor((e.clientY-L.config.yOffset)/L.config.scale),i=t<0||t>=L.config.width-1?J:t,e=n<0||n>=L.config.height-1?P:n;if(i!==V||e!==z){for(var r=i<J?i:J,t=i<V?i:V,o=J<i?i:J,n=V<i?i:V,l=n<o?o:n,a=e<P?e:P,n=e<z?e:z,s=a<n?a:n,c=P<e?e:P,n=z<e?e:z,f=n<c?c:n,u=r<t?r:t;u<=l;u++)for(var g=s;g<=f;g++)Y(u,g,r<=u&&u<=o&&a<=g&&g<=c?H:L.grid[g][u]);V=i,z=e}};k=localStorage.getItem("width"),B=localStorage.getItem("height"),N=localStorage.getItem("game"),k&&(a.value=k),B&&(s.value=B),N&&(N=JSON.parse(N),K(N)),e.addEventListener("click",g,{once:!1,passive:!0}),r.addEventListener("click",d,{once:!1,passive:!0}),o.addEventListener("change",h,{once:!1,passive:!0}),i.addEventListener("click",j,{once:!1,passive:!0}),i.addEventListener("mousedown",D,{once:!1,passive:!0})},{once:!0,passive:!0});
//# sourceMappingURL=es5.js.map
